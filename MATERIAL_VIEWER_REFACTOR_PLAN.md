# 教材ビューア機能 抜本的改革プラン

このプランは、ユーザー体験の向上、技術的負債の解消、そして将来の機能拡張を容易にするための堅牢なアーキテクチャ構築を目的とします。

---

## **プロジェクト引き継ぎ報告 (2025/06/26)**

**現状:**
プロジェクトは現在、**フェーズ4: 品質保証と最適化** の段階にあります。
主要なリファクタリングは完了し、アプリケーションはより堅牢で保守性の高いアーキテクチャに移行しました。
しかし、テスト、パフォーマンス最適化、アクセシビリティ向上のためのいくつかのタスクが残っています。

**完了済みの主要タスク:**
*   **現状分析とコード監査:** 巨大コンポーネントの分割、不安定なデータ永続化ロジック、スケーラビリティに欠けるAPIなど、主要な問題点を特定しました。
*   **データモデルの再設計:** 文字オフセットベースの不安定なハイライト保存形式を廃止し、CSSセレクタと周辺テキストを組み合わせた**Contextual Anchoring**モデルを新たに設計・導入しました。これにより、テキストの変更に対するハイライトの耐久性が大幅に向上しました。(`HIGHLIGHT_DATA_MODEL.md`参照)
*   **開発環境の整備:** `Storybook`と`Vitest`を導入し、コンポーネントの分離開発とユニットテストの基盤を構築しました。
*   **APIの強化:** `/api/extract-keywords` エンドポイントをリファクタリングし、信頼性の低いインメモリキャッシュを**Vercel KV**を利用した永続的なキャッシュに置き換えました。これにより、APIの応答性と安定性が向上しました。
*   **データ永続化層の抽象化:** `HighlightService`を導入し、データ操作ロジック（Firestore/LocalStorage）をコンポーネントから完全に分離しました。これにより、コードの見通しが良くなり、将来のデータソース変更が容易になりました。
*   **コンポーネントの再設計:** 巨大だった教材ビューアコンポーネント (`/app/materials/page.tsx`) を、責務ごとに`PdfRenderer`、`HtmlRenderer`、`TableOfContents`などの小さなコンポーネントに分割しました。
*   **主要機能の再実装:**
    *   PDFビューアを`react-pdf`を用いて再実装し、ページ仮想化（`react-window`）によるパフォーマンス改善を行いました。
    *   HTMLビューアを**Shadow DOM**を用いて再実装し、スタイルがアプリケーション全体に影響を与える問題を解決しました。
    *   目次機能とテキスト検索機能を実装しました。
    *   新しいデータモデルとサービス層を利用して、ハイライト機能とノート機能を再実装しました。

**残存タスクと今後の課題:**
*   **E2Eテストの安定化 (最優先):** CypressによるE2EテストがFirebase認証フローの問題で失敗しています。`cy.request()`によるAPIベースのログインや、カスタムコマンドによるUI操作の安定化など、信頼性の高い認証方法を確立する必要があります。
*   **パフォーマンスチューニング:** `React DevTools`のプロファイラ等を用いた詳細なボトルネック分析と、不要な再レンダリングの最適化が必要です。
*   **アクセシビリティ (a11y) の向上:** キーボードのみでの完全な操作性の確保や、ARIA属性の網羅的な追加など、やるべきことは多く残っています。
*   **ドキュメントの更新:** `README.md`や`GEMINI.md`など、プロジェクトの現状に合わせてドキュメントを更新する必要があります。

**引き継ぎ担当者への推奨事項:**
1.  まず`npm test`を実行し、ユニット/コンポーネントテストがすべてパスすることを確認してください。
2.  次に、`npm run dev`で開発サーバーを起動し、手動で主要な機能（教材の表示、ハイライト、ノート作成）が一通り動作することを確認してください。
3.  最優先で**E2Eテストの安定化**に取り組むことを推奨します。安定したテスト基盤は、今後の機能追加やリファクタリングの安全性を担保します。

---

## フェーズ1: 現状分析と基盤整備 (12項目)

改革を始める前に、現状を正確に把握し、開発の土台を固めます。

### 1. 機能要件の再定義
- [ ] 1.1. 教材ビューアの必須機能（MVP）を明確化する。
- [ ] 1.2. ハイライト、ノート、AI連携の理想的なユーザーフローを文書化する。
- [ ] 1.3. 対象デバイス（PC、タブレット、スマホ）ごとのUI/UX要件を定義する。

### 2. コード監査
- [x] 2.1. 関連コンポーネント (`/app/materials`, `HighlightManager`等) のコードをレビューし、問題点をリストアップする。
- [x] 2.2. 既存のデータ構造（LocalStorage, Firebase）の問題点を分析する。
- [x] 2.3. API (`/api/extract-keywords`) のパフォーマンスと堅牢性を評価する。

### 3. データモデルの再設計
- [x] 3.1. **【最重要】** ハイライトのデータ構造を再設計する。テキストの変更に強い、安定的で永続的な位置特定方法（例: XPath, CSS Selector, Rangeオフセット）を定義する。
- [x] 3.2. ノート機能のデータモデルを定義する（ハイライトとの関連付けを含む）。
- [x] 3.3. 教材自体のメタデータ（目次、ページ構成など）を管理する構造を定義する。

### 4. 開発環境の整備
- [x] 4.1. Storybookを導入し、UIコンポーネントを独立して開発・確認できる環境を構築する。
- [x] 4.2. VitestまたはJestを導入し、ユニットテスト/インテグレーションテストの基盤を整備する。
- [ ] 4.3. 既存の関連コードから不要なコード（デッドコード）を削除する。

---

## フェーズ2: コアアーキテクチャの再構築 (13項目)

堅牢なバックエンドとフロントエンドの土台を構築します。

### 5. APIの強化
- [x] 5.1. `extract-keywords` APIのレスポンス形式を標準化する（OpenAPI/Swaggerでのスキーマ定義を推奨）。
- [x] 5.2. APIに堅牢なエラーハンドリングとロギングを実装する。
- [x] 5.3. Vercel KVやRedis等を活用したサーバーサイドキャッシュを導入し、Gemini APIのコールを削減、高速化する。

### 6. データ永続化層の抽象化
- [x] 6.1. Firebase (Firestore) との通信ロジックを抽象化するサービスクラス (`HighlightService`, `NoteService`) を作成する。
- [x] 6.2. LocalStorageへのフォールバック戦略をサービスクラス内にカプセル化する。
- [x] 6.3. リアルタイム同期とオフライン時のデータ競合解決ロジックを設計・実装する。 (`CONFLICT_RESOLUTION_STRATEGY.md` にて戦略を定義)

### 7. フロントエンド状態管理
- [ ] 7.1. 教材ビューア専用の状態管理ストア（Context API, Zustand, or Jotai）を導入し、複雑なUI状態をコンポーネントから分離する。
- [ ] 7.2. データ取得ロジックをカスタムフック (`useHighlights`, `useMaterialContent`) に集約する。

### 8. コンポーネントの再設計と分割
- [x] 8.1. 巨大な教材ビューアコンポーネントを機能ごとに分割する。
- [x] 8.2. `MaterialToolbar`: 操作ボタン（検索、目次、設定など）を管理。 (未着手)
- [x] 8.3. `MaterialRenderer`: PDFやHTMLの表示責務を持つ。 (`PdfRenderer`, `HtmlRenderer`として実装)
- [x] 8.4. `HighlightLayer`: `MaterialRenderer`の上に重なり、ハイライトの描画のみ責務を持つ。
- [x] 8.5. `NotePanel`: 選択中のハイライトに紐づくノートを表示・編集する。 (`NoteEditor`として実装)

---

## フェーズ3: 機能の再実装とUI/UXの向上 (15項目)

新しいアーキテクチャの上で、ユーザーが直接触れる機能を高品質に再実装します。

### 9. 教材ビューア本体
- [x] 9.1. `react-pdf` や `pdf.js` などの安定したライブラリを用いて、PDFビューアを再実装する。
- [x] 9.2. HTML教材のレンダリングにおいて、スタイルがアプリ全体に影響しないようShadow DOMやiframeの利用を検討・実装する。
- [x] 9.3. 目次機能とページ内ジャンプ機能を実装する。
- [x] 9.4. テキスト検索機能（キーワードハイライト付き）を実装する。

### 10. ハイライト機能
- [x] 10.1. マウスやタッチ操作でテキストを正確に選択できるUIを実装する。
- [x] 10.2. 選択後に表示されるポップアップ（色選択、ノート追加ボタン）を実装する。
- [x] 10.3. 再設計したデータモデルに基づき、ハイライトの描画ロジックを`HighlightLayer`に実装する。
- [ ] 10.4. ハイライトの削除・色変更機能を実装する。

### 11. ノート機能
- [x] 11.1. `NotePanel`コンポーネントを実装し、ノートの表示・作成・編集・削除を行えるようにする。
- [ ] 11.2. ノートが入力されているハイライトには、特別なインジケーターを表示する。

### 12. AI連携（質問→教材）
- [x] 12.1. 質問ページから教材へ遷移する際のキーワードとアンカー（位置情報）の受け渡し方法を確立する。
- [x] 12.2. 教材ビューア読み込み時にアンカー情報があれば、該当箇所へ自動スクロールし、一時的にハイライトする機能を実装する。

### 13. UI/UXの洗練
- [ ] 13.1. ローディング状態（スケルトン表示）とエラー状態（エラーメッセージ）を明確に表示する。
- [ ] 13.2. レスポンシブデザインを徹底し、あらゆる画面サイズで快適に操作できるようにする。
- [ ] 13.3. 全ての操作が直感的でスムーズに感じられるよう、アニメーションやトランジションを適切に追加する。

---

## フェーズ4: 品質保証と最適化 (10項目)

公開に値する品質を確保するための最終仕上げです。

### 14. テスト
- [x] 14.1. データサービス層とカスタムフックに対するユニットテストを作成する。
- [x] 14.2. 主要なUIコンポーネント（Toolbar, NotePanel等）のコンポーネントテストを作成する。
- [ ] 14.3. **【重要】** Cypressを導入し、「問題を選択→教材へ移動→ハイライトを追加→ノートを記入→Firebaseに保存される」という一連の流れをE2Eテストで自動化する。(認証フローの課題により中断)

### 15. パフォーマンス最適化
- [x] 15.1. PDFのページを仮想化（表示領域のみレンダリング）し、パフォーマンスを改善する。
- [ ] 15.2. React DevToolsのプロファイラや`console.time`を使い、不要な再レンダリングを特定・修正する。
- [ ] 15.3. Web Vitalsを計測し、特にLCP（最大コンテンツの描画時間）とINP（インタラクションの応答性）を改善する。

### 16. アクセシビリティ (a11y)
- [ ] 16.1. 全ての操作がキーボードのみで可能であることを確認する。
- [ ] 16.2. 適切なARIA属性を付与し、スクリーンリーダーでの利用性を担保する。

### 17. ドキュメント
- [ ] 17.1. `README.md`と`GEMINI.md`を新しいアーキテクチャに合わせて更新する。
- [ ] 17.2. Storybook上にコンポーネントの仕様や使い方を記述する。
