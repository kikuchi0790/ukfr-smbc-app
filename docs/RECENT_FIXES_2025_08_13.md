# 2025年8月13日の修正記録

## PDF.js Worker初期化エラーの修正

### 問題
- `Error: No "GlobalWorkerOptions.workerSrc" specified` エラーが頻発
- PDFビューアが正常に動作しない

### 原因
- react-pdfのworker初期化が非同期で、PDFレンダリング時に間に合わない競合状態
- CDNのURLやファイル拡張子の不一致

### 解決策
1. 専用の`PdfWorkerInit.tsx`コンポーネントを作成
2. モジュールレベルで同期的にworkerを初期化
3. jsDelivr CDNを使用し、拡張子を`.mjs`に修正

## RAG検索機能の大幅改善

### 問題点
1. HTMLファイルのページマーカーが不完全（StudyCompanionは1ページのみ）
2. チャンクサイズが大きすぎて精度が低い（2000文字）
3. 問題文全体＋選択肢を検索クエリに使用していた
4. 低関連度の結果もすべて返していた
5. 日本語の質問→英語の教材のマッチング精度が低い

### 実施した改善

#### 1. インデックスの完全再構築
- **変更前**: HTMLファイルから抽出（165チャンク、ページ情報不正確）
- **変更後**: テキストファイル（`_ja_fixed.txt`）から抽出（699チャンク、正確なページ情報）
- 新スクリプト: `scripts/build-material-index-from-text.ts`

#### 2. チャンクサイズの最適化
- **変更前**: 2000文字（overlap 400文字）
- **変更後**: 350文字（overlap 100文字）
- 効果: より細かい粒度で正確なマッチングが可能に

#### 3. 検索クエリの最適化
- `extractKeyPhrases`関数を追加
- 問題文から重要な部分（200文字以内）のみを抽出
- 選択肢を除外してノイズを削減

#### 4. スコア閾値の実装
- 類似度スコア0.7未満の結果を自動除外
- 低関連度のノイズを削減

#### 5. MMRパラメータの調整
- λ値: 0.5→0.7（精度重視）
- より関連性の高い結果を優先

#### 6. GPT-4リランキングの強化
- 日英クロスリンガル対応を明示的にプロンプトに追加
- 金融規制用語（FCA、PRA等）への注意を喚起
- パッセージに番号を付けて選択を明確化
- temperature: 0→0.1、max_tokens: 200→300

#### 7. キャッシュの最適化
- TTL: 7日→24時間に短縮
- 開発中の変更が即座に反映される

#### 8. エイリアスマップの拡張
- 5項目→15項目に拡張
- より多くの金融規制用語をカバー

#### 9. デバッグ機能の追加
- 詳細なRAGデバッグログをサーバーサイドに追加
- 検索クエリの変換過程を記録
- 上位結果のスコアと内容を表示

### 結果
- **チャンク数**: 165→699（4.2倍増加）
- **ページ精度**: 不正確→正確（Checkpoint: 44ページ、StudyCompanion: 112ページ）
- **検索精度**: 大幅に向上（特に日本語→英語のマッチング）
- **応答速度**: キャッシュとクエリ最適化により改善

### 今後の課題
- Qdrantへの移行（現在はローカルJSON）
- ハイブリッド検索（ベクトル＋キーワード）の実装
- セマンティックチャンキングの導入