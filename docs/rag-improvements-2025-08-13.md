# RAG System Major Improvements - 2025-08-13

## 問題の背景
FSCS £85,000の保証額に関する問題で、RAGシステムが誤ったセクション（16. 海外の者に代わっての金融プロモーション）に誘導していた。
正しくは「21. FSCS スキーム限度額」セクションに誘導すべきだった。

## 実施した改善

### Phase 1: 即効性の高い改善

#### 1. GPT-5へのモデルアップグレード
- **変更ファイル**: `/app/api/rerank/route.ts`, `/app/api/retrieve/route.ts`
- **変更内容**: `gpt-4o` → `gpt-5`
- **効果**: 最高レベルの推論能力で日英クロスリンガル理解を実現

#### 2. Chain-of-Thought推論の導入
- **変更ファイル**: `/app/api/rerank/route.ts`
- **実装内容**:
  - 10点満点のスコアリング基準（直接的関連性4点、数値一致3点、セクション関連性3点）
  - 4段階の推論プロセス
  - 確信度レベルの出力

#### 3. 高度なクエリ拡張
- **変更ファイル**: `/app/api/retrieve/route.ts`
- **実装内容**:
  - GPT-5によるクエリ拡張（3つの検索クエリ生成）
  - 数値抽出と特化クエリ生成
  - マルチクエリ検索と結果融合

#### 4. ハイブリッド検索の実装
- **変更ファイル**: `/services/vector-client.ts`
- **実装内容**:
  - 数値インデックス（£85,000等の金額で直接検索）
  - セクションインデックス（セクションタイトルで検索）
  - ベクトル検索との結果統合

### Phase 2: 構造的改善

#### 1. セクション構造保持インデックス
- **新規ファイル**: `/scripts/build-material-index-advanced.ts`
- **特徴**:
  - セクション階層の保持
  - 適応的チャンク分割（重要セクションは全体を1チャンクに）
  - リッチメタデータ（金額、エンティティ、重要度スコア）
  - text-embedding-3-large対応

#### 2. 強化されたリランキング
- **変更ファイル**: `/app/api/rerank/route.ts`
- **実装内容**:
  - パッセージ数を5→8に増加
  - 解説文と抽出金額の活用
  - 詳細な推論ログ出力

#### 3. 学習セッションとの統合強化
- **変更ファイル**: `/app/study/session/page.tsx`
- **実装内容**:
  - 問題の解説文をRAGに渡す
  - 金額の自動抽出
  - 詳細なデバッグログ

## 技術詳細

### モデル選択
- **GPT-5**: リランキングとクエリ拡張（最高精度）
  - 入力: $1.25/1M トークン
  - 出力: $10/1M トークン
  - 400,000トークンコンテキスト
  - 2024年9月30日知識カットオフ

### 新コマンド
```bash
# 高度なインデックス構築（セクション構造保持）
npm run build:index:advanced

# 従来のインデックス構築
npm run build:index:text

# Qdrantへのアップロード
npm run upload:qdrant
```

### 環境変数
```env
# OpenAI（.env.local）
OPENAI_API_KEY=your-key

# ベクタバックエンド
VECTOR_BACKEND=qdrant  # またはローカル

# Qdrant（オプション）
QDRANT_URL=your-url
QDRANT_API_KEY=your-key
QDRANT_COLLECTION=materials_passages
```

## 期待される成果

### 精度向上
- FSCS £85,000問題: 95%以上の精度で正しいセクションへ
- 数値を含む問題: 直接検索により確実にヒット
- セクション関連問題: セクションタイトル検索で高精度

### パフォーマンス
- レスポンス時間: 2秒以内を維持
- キャッシュ: 24時間TTLで高速化
- 並列処理: マルチクエリ検索

### コスト
- 月間推定: $10-15（通常使用時）
- ROI: 学習効率の大幅向上により十分なリターン

## トラブルシューティング

### インデックス構築エラー
- トークン制限エラー: チャンクサイズを調整（現在は6000文字で自動トランケート）
- エンベディングエラー: text-embedding-3-smallへ自動フォールバック

### 検索精度が低い場合
1. インデックス再構築: `npm run build:index:advanced`
2. キャッシュクリア: 24時間後に自動クリア
3. デバッグログ確認: コンソールで`[RAG Debug]`を確認

## 今後の改善案
1. フィードバックループの実装（ユーザーの実際のナビゲーション結果を学習）
2. ファインチューニングの検討
3. 評価メトリクスの自動計測
4. A/Bテストの実装

## 関連ドキュメント
- `/CLAUDE.md`: プロジェクト全体のコンテキスト
- `/scripts/build-material-index-advanced.ts`: 高度なインデックス構築スクリプト
- `/app/api/retrieve/route.ts`: 検索API
- `/app/api/rerank/route.ts`: リランキングAPI