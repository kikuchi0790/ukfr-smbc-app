# 教材画面での問題文表示機能とRAGキャッシュ改善 - 2025-08-13

## 概要
教材画面で問題文と選択肢を表示する機能を追加し、RAG検索結果のキャッシュを改善しました。

## 実装内容

### 1. 問題文表示パネル機能
教材画面の左側に問題文と選択肢を表示するパネルを追加しました。

#### 主な機能：
- **スプリットビュー表示**: 左側に問題、右側に教材を並べて表示
- **リサイズ可能**: ドラッグでパネル幅を調整可能（20%〜50%）
- **表示/非表示切り替え**: ヘッダーのボタンでパネルの表示を切り替え
- **言語切り替え**: 日本語/英語の切り替えボタン
- **回答状態の表示**: 正解/不正解、選択した選択肢のハイライト
- **解説表示**: 回答済みの場合は解説も表示

#### 実装詳細：
1. **QuestionPanelコンポーネント** (`/components/QuestionPanel.tsx`)
   - 問題文、選択肢、解説を表示する再利用可能なコンポーネント
   - 言語切り替え、折りたたみ機能を実装

2. **materialNavigationState拡張** 
   - 問題データ全体（Question型）を含めるように拡張
   - selectedAnswer、showResult、showJapaneseの状態も保存

3. **教材画面レイアウト変更** (`/app/materials/page.tsx`)
   - flexレイアウトでスプリットビューを実装
   - リサイズハンドラーの実装
   - パネル表示/非表示ボタンの追加

### 2. RAG検索結果のキャッシュ改善

#### 改善内容：
- **セッション内キャッシュ**: 同じ問題のRAG検索結果を再利用
- **即座の遷移**: キャッシュヒット時は「キーワードを抽出中...」を表示せず即座に遷移
- **永続化**: sessionStorageにキャッシュを保存、ページリロードにも対応
- **選択的クリア**: 次の問題に移る時のみ現在の問題のキャッシュをクリア

#### 実装詳細：
1. **ragResultsCacheの改善**
   - MapベースのメモリキャッシュをsessionStorageと同期
   - ページリロード時にキャッシュを復元

2. **handleCheckInMaterials関数の最適化**
   - キャッシュチェックを最初に実行
   - キャッシュヒット時は検索をスキップして即座に遷移

3. **キャッシュライフサイクル**
   - 問題ごとにキャッシュを管理
   - 異なる問題に移動時のみクリア
   - セッション終了まで保持

## 技術的詳細

### データフロー
```
1. 学習セッション
   ↓ 「教材で詳しく確認」クリック
2. RAGキャッシュチェック
   ├─ キャッシュヒット → 即座に教材画面へ遷移
   └─ キャッシュミス → RAG検索実行 → 結果をキャッシュ → 教材画面へ遷移
3. 教材画面
   ├─ navigationStateから問題データ取得
   ├─ QuestionPanelに問題表示
   └─ MaterialViewerに教材表示
```

### パフォーマンス改善
- 初回RAG検索: 約2-3秒
- キャッシュヒット時: 即座（< 100ms）
- メモリ使用量: 問題数 × 約5KB（キャッシュサイズ）

## ユーザー体験の向上

### Before
- 教材画面で問題文が見えない → 問題と教材の比較が困難
- 戻るたびにRAG検索で2-3秒待機 → ストレスフル

### After
- 問題と教材を並べて表示 → 学習効率が向上
- 一度検索した結果は即座に表示 → 快適な学習体験

## 今後の改善案

1. **問題パネルの機能拡張**
   - メモ機能の追加
   - 問題から教材内の関連箇所へのジャンプ
   - 問題の難易度表示

2. **キャッシュの最適化**
   - IndexedDBへの移行（より大容量のキャッシュ）
   - キャッシュの有効期限設定
   - LRUキャッシュアルゴリズムの実装

3. **UIの改善**
   - モバイル対応の強化
   - キーボードショートカットの追加
   - アニメーション効果の追加